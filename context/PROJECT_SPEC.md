# 반도체 원가 증감 차이분석 시스템 — 프로젝트 기획서

> **문서 버전**: v1.0  
> **작성일**: 2025.02.08  
> **목적**: Cursor 기반 프로토타이핑을 위한 전체 시스템 기획서  
> **관련 문서**: `DATA_PREPARATION.md`, `GRAPH_DB_SCHEMA.md`

---

## 1. 프로젝트 개요

### 1.1 목적

반도체 원가의 전월 대비 차이분석을 자동화하여, 숫자 분해뿐 아니라 원인 해석까지 LLM이 수행하고, 경영진·원가·생산·구매 부서가 하나의 시스템에서 공유한다.

### 1.2 현재 상황

- SAP 시스템에서 별도 CBO 프로그램으로 원가 계산 운영 중
- 원가 계산 시스템은 정상 운영, 월별 스냅샷 및 중간값 이력 모두 보존
- 차이분석 시스템은 미구축 → 담당자 수작업 분석, 시간 소요 및 커뮤니케이션 어려움
- MES, PLM, 구매시스템 등 레거시 시스템에서 데이터를 SAP으로 전송하는 구조

### 1.3 핵심 요구사항

| 항목 | 내용 |
|------|------|
| 비교 기준 | 전월 대비 (1차), 계획 대비 (추후 확장) |
| 교차 차이 | C안: 배부율 차이에 흡수 (당월 배부량 기준) |
| LLM 역할 | 해석 자동화 → 이상 탐지 → 질의응답 (우선순위 순) |
| LLM 판단 | A안: 자동 판단 (증거 기반, 신뢰도 명시) |
| 인과관계 생성 | 규칙 기반으로 기본 골격, LLM이 보강 |
| 소스시스템 연계 | 상세 데이터까지 (확장 가능한 구조 설계) |
| 보고서 소비자 | 경영진, 원가팀, 생산팀, 구매팀 (4개 뷰) |

---

## 2. 제품 및 공정 구조

### 2.1 제품 계층

```
제품군 (메모리, HBM, 낸드, P5 등) ── ~10개
  └→ 제품코드
       ├─ 전공정(FAB): ~100개
       └─ 후공정(패키징): ~800개
```

### 2.2 공정 구조

```
대공정 10개
  ├─ 전공정 (배부 방식: 전체 비용 집계 → 배부기준으로 배부)
  │    └─ 공정군 (식각, 증착 등) → FAB Step 750개
  │         └─ Step별 장비 → 장비별 기료
  │
  └─ 후공정 (조립라인: 재료비 집계, 가공비 배부)
```

### 2.3 배부기준

| 비용 구분 | 배부기준 |
|-----------|----------|
| 재료비 | 표준 BOM |
| 가공비 | 장비 가동시간 ST |
| 생산수량 기반 | 생산수량 |

---

## 3. 시스템 아키텍처

```
[기존 유지] SAP CBO (원가 스냅샷, 중간값 이력)
[기존 유지] MES / PLM / 구매시스템
                │
                ▼ 추출
[신규] Oracle DB ─── 스냅샷 적재 + 차이 계산 (Python)
[신규] Neo4j DB ─── 인과관계 그래프 + LLM 탐색용
[신규] LLM 엔진 ── 증거 기반 자동 해석
[신규] 웹 UI ───── 대시보드 + 챗 + 자동 보고서
```

### 3.1 핵심 설계 원칙

- **SAP CBO는 건드리지 않는다**: 기존 원가 시스템 그대로, 결과만 추출
- **하이브리드 DB**: Oracle(숫자 계산) + Neo4j(인과 추적)
- **LLM은 계산하지 않는다**: 모든 숫자는 Python이 계산, LLM은 해석만
- **증거 없이 판단하지 않는다**: 시계열, 이벤트, 파급, 과거사례 기반
- **확장 가능한 구조**: 소스시스템 데이터 범위를 점진적으로 확대

---

## 4. Drill-down 분석 흐름 (6단계)

```
[Level 0] 총괄 요약
  "이번 달 총원가 전월 대비 +3.2% 증가"

[Level 1] 계정별 증감
  감가상각비 +5%, 재료비 +2%, 인건비 -1%...
  → "어떤 비용이 올랐나?"

[Level 2] 제품군별 증감 (메모리/HBM/낸드/P5...)
  HBM +8%, DDR5 +2%, 낸드 -1%...
  → "어떤 제품군이 문제인가?"

[Level 3] 제품코드별 원가요소 분해
  HBM_001: 배부율 차이 +6%, 배부량 차이 +2%
  → "왜 올랐나? 비용인가, 물량인가?"

[Level 4] 배부기준 분석
  배부율 상승 원인: 총비용 +3% / 총ST -2%
  → "비용이 늘었나, 분모가 줄었나?"

[Level 5] 소스시스템 연계
  MES: 장비 가동률 85%→78%
  PLM: BOM 변경 이력 2건
  구매: 자재 X 단가 +12%
  → "실물에서 무슨 일이 있었나?"
```

---

## 5. 차이 분해 로직

### 5.1 전공정 (배부 방식)

```
제품 원가 = 배부율 × 배부량

차이 분해 (C안 — 교차차이를 배부율에 흡수):
  배부율 차이: (R₁ - R₀) × Q₁    ← 비용 자체가 변했다
  배부량 차이: R₀ × (Q₁ - Q₀)    ← 제품 Mix가 변했다

배부율 차이를 다시 분해:
  총비용 변동 효과:  (C₁ - C₀) / B₀
  총배부기준 변동 효과: C₀ × (1/B₁ - 1/B₀)

  여기서:
    R = 배부율, Q = 배부량
    C = 총비용, B = 총배부기준량
    첨자 0 = 전월, 1 = 당월
```

### 5.2 후공정 재료비 (집계 방식)

```
재료비 = Σ (투입량 × 단가)

차이 분해:
  단가 차이: Σ (P₁ - P₀) × Q₁    ← 자재 가격이 변했다
  사용량 차이: Σ P₀ × (Q₁ - Q₀)  ← BOM이나 수율이 변했다
```

### 5.3 후공정 가공비 (배부 방식)

전공정과 동일한 배부 분해 로직 적용.

---

## 6. LLM 엔진 설계

### 6.1 역할 정의

| 우선순위 | 역할 | 설명 |
|----------|------|------|
| 1 | 해석 자동화 | 증거 기반 서술형 코멘트 자동 생성 |
| 2 | 이상 탐지 | 통상 변동 범위 이탈 자동 플래깅 + 원인 제시 |
| 3 | 질의응답 | 그래프 탐색 기반 자연어 답변 |

### 6.2 핵심 원칙

```
원칙 1: LLM은 계산하지 않는다. 해석만 한다.
        모든 숫자는 Python이 미리 계산하여 제공한다.

원칙 2: LLM은 증거 없이 판단하지 않는다.
        반드시 증거 1~4를 기반으로 근거를 명시한다.

원칙 3: LLM의 판단에는 항상 신뢰도가 붙는다.
        증거가 충분하면 "판단", 부족하면 "추정"으로 구분한다.
        추정인 경우 "담당자 확인 필요"를 표시한다.
```

### 6.3 증거 생성 엔진 (Python)

LLM에게 제공되는 증거 패키지:

| 증거 | 내용 | 출처 |
|------|------|------|
| 증거 1: 시계열 패턴 | 최근 6~12개월 추이, 이동평균 대비 이탈도, 계절성 | Oracle (스냅샷) |
| 증거 2: 이벤트 매칭 | 동일 시점 발생 소스시스템 변동 사항 | MES/PLM/구매 |
| 증거 3: 파급 분석 | 동일 배부기준 공유 제품 목록 + 동반 변동 여부 | Oracle (배부 결과) |
| 증거 4: 유사 과거 사례 | 과거 비슷한 변동 패턴 + 당시 원인 + 이후 추이 | Neo4j (과거 차이 노드) |

### 6.4 LLM 프롬프트 구조 (예시)

```
[분석 대상]
  제품군: HBM / 제품코드: HBM_001
  원가요소: 전공정 감가상각비 배부율
  변동: 전월 대비 +12%

[증거 1: 시계열]
  6개월 추이: 98, 100, 101, 99, 100, 112
  이동평균: 99.6 / 이탈도: +12.4% (통상 ±3%)

[증거 2: 동시 발생 이벤트]
  MES: FAB3 ETCH_A01 가동률 85%→78% (▼7%p)
  MES: FAB3 신규라인 가동 개시 (1월 15일~)
  PLM: BOM 변경 없음 / 구매: 해당 없음

[증거 3: 파급]
  동일 배부기준 공유: DDR5_001(+10.1%), LPDDR5_001(+10.3%)

[증거 4: 과거 유사 사례]
  2024.08: FAB2 신규라인 가동 시 배부율 +9% → 3개월 후 정상화

[판단 요청]
  1. 주요 원인 / 2. 일시적 vs 구조적 / 3. 주의 등급 / 4. 보고 요약
```

### 6.5 LLM 출력 구조

```
{
  "summary": "HBM 전공정 배부율 전월 대비 12% 상승...",
  "root_cause": "FAB3 신규라인 가동 초기, 식각 장비 가동률 하락",
  "classification": "일시적",
  "confidence": "높음",
  "alert_level": "관찰",  // 정상 / 관찰 / 경고 / 긴급
  "affected_products": ["DDR5_001", "LPDDR5_001"],
  "recommendation": "향후 2개월간 가동률 추이 모니터링",
  "evidence_refs": ["시계열 이탈 +12.4%", "ETCH_A01 가동률 -7%p", "2024.08 유사 사례"]
}
```

---

## 7. 부서별 뷰 설계

| 뷰 | 대상 | 핵심 관심사 | 시작 화면 |
|----|------|------------|----------|
| 경영진 뷰 | CEO, CFO | 제품군별 원가 증감 + 핵심 원인 1~2줄 | Level 0 → Level 2 |
| 원가팀 뷰 | 원가 담당자 | 계정/공정별 상세 Drill-down 전체 | Level 1 → Level 5 |
| 생산팀 뷰 | 생산 담당자 | 수율/가동률 변동 → 원가 영향 | MES 이벤트 → Level 3 |
| 구매팀 뷰 | 구매 담당자 | 자재 단가 변동 → 원가 영향 | 구매 이벤트 → Level 3 |

---

## 8. 매월 실행 프로세스

```
[매월 마감 후 — 자동 실행]

Step 1: SAP CBO → Oracle 스냅샷 복사
        (원가결과, 배부율, 배부결과, BOM 등)

Step 2: 소스시스템 → Oracle 이벤트 적재
        (MES 가동률/수율, PLM BOM변경, 구매 단가변동)

Step 3: Python 차이 계산 (Oracle 내)
        (전공정 배부 분해, 후공정 재료비/가공비 분해)

Step 4: Neo4j 그래프 갱신
  ├─ 4a: 상설 그래프 갱신 (신규 제품/장비/자재 마스터)
  ├─ 4b: 차이 노드 생성 (계층적 — 제품군 전체 + 제품코드 임계값 초과)
  ├─ 4c: 이벤트 노드 생성
  └─ 4d: 규칙 기반 인과관계 연결 (원인/근거/파급)

Step 5: LLM 해석 생성
  ├─ 5a: 각 차이 노드에 대해 증거 패키지 조립
  ├─ 5b: LLM 호출 → 해석 코멘트 생성
  └─ 5c: 해석 결과를 차이 노드 속성으로 저장

Step 6: 보고서 자동 생성
  ├─ 6a: 경영진 요약 보고서
  └─ 6b: 부서별 상세 보고서

Step 7: UI 조회 가능 + 알림 발송
```

---

## 9. 인과관계 자동 생성 규칙

### 규칙 체계

```
규칙 1: 제품 원가 차이 → 원가요소별 분해
  IF 제품 원가 차이 발생
  THEN 각 공정 × 원가요소의 차이를 계산
  THEN 기여도 상위 항목을 "원인"으로 연결

규칙 2: 배부율 차이 → 총비용/총배부기준량 분해
  IF 배부율 차이 발생
  THEN 총비용 변동과 총배부기준량 변동을 비교
  THEN 기여도가 큰 쪽을 "원인"으로 연결

규칙 3: 총배부기준량(ST) 변동 → MES 이벤트 매칭
  IF 총ST 변동 발생
  THEN 해당 공정의 MES 장비 가동률/수율 변동 이벤트를 시점 매칭
  THEN "근거"로 연결

규칙 4: 재료비 변동 → 단가/사용량 분해
  IF 재료비 차이 발생
  THEN 단가 차이 → 구매 이벤트 매칭 → "근거" 연결
  THEN 사용량 차이 → PLM BOM 변경 이벤트 매칭 → "근거" 연결

규칙 5: 파급 관계 생성
  IF 배부율 차이가 임계값 초과
  THEN 동일 배부기준 공유 제품들의 동반 변동을 확인
  THEN "파급"으로 연결
```

---

## 10. 기술 스택 (프로토타입)

| 구분 | 기술 | 비고 |
|------|------|------|
| 분석용 DB | Oracle (또는 PostgreSQL) | 스냅샷 + 차이 계산 |
| 그래프 DB | Neo4j | 인과관계 + LLM 탐색 |
| 차이 계산 | Python (pandas, numpy) | 분해 공식 구현 |
| LLM | 자사 LLM (또는 오픈 LLM) | 해석/이상탐지/질의응답 |
| 백엔드 | Python (FastAPI) | API 서버 |
| 프론트엔드 | React + 시각화 라이브러리 | 대시보드 + 챗 |
| 프로토타입 DB | SQLite + Neo4j | 로컬 개발용 |

---

## 11. 프로토타입 범위

### 포함

- 샘플 데이터 기반 전체 흐름 구현
- 전공정/후공정 차이 분해 로직
- Neo4j 그래프 구축 (상설 + 월별 차이 노드)
- 규칙 기반 인과관계 자동 생성
- LLM 해석 자동화 (증거 기반)
- 기본 대시보드 (Drill-down 6단계)
- 부서별 뷰 4종

### 미포함 (추후)

- SAP 실데이터 연동 (프로토타입은 샘플 데이터)
- 계획 대비 차이분석
- 실시간 알림 시스템
- 보안/권한 관리

---

## 12. 관련 문서 참조

| 문서 | 내용 |
|------|------|
| `DATA_PREPARATION.md` | 샘플 데이터 구조, Oracle 테이블 설계, 데이터 생성 스크립트 |
| `GRAPH_DB_SCHEMA.md` | Neo4j 노드/관계 정의, 상설 그래프 구조, 월별 차이 노드 생성 규칙 |
